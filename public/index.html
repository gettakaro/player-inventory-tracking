<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Takaro Player & Inventory Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="header">
      <h1>Takaro Player & Inventory Tracker</h1>
      <div class="header-controls">
        <span id="app-version" class="app-version"></span>
        <select id="domain-selector" class="domain-selector" style="display: none;"></select>
        <select id="server-switcher" class="server-switcher" style="display: none;"></select>
        <span id="connection-status" class="status-indicator offline">Disconnected</span>
      </div>
    </header>

    <!-- Config Panel -->
    <div id="config-panel" class="panel" style="display: none;">
      <h2>Server Configuration</h2>

      <!-- Game Server Selection -->
      <div id="server-select-container" class="form-group">
        <label for="game-server">Game Server</label>
        <select id="game-server">
          <option value="">Select a server...</option>
        </select>
      </div>

      <button id="start-map-btn" class="btn btn-success" style="display: none;">
        View Map
      </button>
    </div>

    <!-- Main Map Area -->
    <div id="map-container" style="display: none;">
      <!-- Controls -->
      <div class="map-controls">
        <div class="control-group">
          <label>
            <input type="checkbox" id="show-paths" />
            <span class="marker-indicator path"></span> Movement Paths
          </label>
        </div>

        <div class="control-group heatmap-controls">
          <label>
            <input type="checkbox" id="show-heatmap" />
            <span class="marker-indicator heatmap"></span> Heatmap
          </label>
          <label class="heatmap-filter-toggle" style="display: none;">
            <input type="checkbox" id="heatmap-filter-selection" />
            Selected only
          </label>
        </div>

        <div id="heatmap-settings" class="heatmap-settings" style="display: none;">
          <label class="slider-label">
            Radius
            <input type="range" id="heatmap-radius" min="10" max="50" value="25" />
          </label>
          <label class="slider-label">
            Blur
            <input type="range" id="heatmap-blur" min="5" max="30" value="15" />
          </label>
        </div>

        <div class="control-group date-filter">
          <div class="time-range-selector">
            <select id="time-range-preset" title="Select time range">
              <optgroup label="Seconds">
                <option value="30s" selected>Last 30 seconds</option>
                <option value="60s">Last 60 seconds</option>
              </optgroup>
              <optgroup label="Minutes">
                <option value="1m">Last 1 minute</option>
                <option value="5m">Last 5 minutes</option>
                <option value="15m">Last 15 minutes</option>
                <option value="30m">Last 30 minutes</option>
              </optgroup>
              <optgroup label="Hours">
                <option value="1h">Last 1 hour</option>
                <option value="3h">Last 3 hours</option>
                <option value="6h">Last 6 hours</option>
                <option value="12h">Last 12 hours</option>
                <option value="24h">Last 24 hours</option>
              </optgroup>
              <optgroup label="Days">
                <option value="2d">Last 2 days</option>
                <option value="7d">Last 7 days</option>
              </optgroup>
              <option value="custom">Custom date range...</option>
            </select>
          </div>
          <div id="custom-date-inputs" class="custom-date-inputs" style="display: none;">
            <div class="date-input-group">
              <label for="start-date">From:</label>
              <input type="datetime-local" id="start-date" />
            </div>
            <div class="date-input-group">
              <label for="end-date">To:</label>
              <input type="datetime-local" id="end-date" />
            </div>
          </div>
          <button id="apply-range-btn" class="btn btn-secondary" style="display: none;">Apply</button>
        </div>

        <div class="control-group area-search-controls icon-toolbar">
          <button id="draw-rect-btn" class="btn btn-icon btn-secondary" title="Draw rectangle to search area" aria-label="Draw rectangle">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
            </svg>
          </button>
          <button id="draw-circle-btn" class="btn btn-icon btn-secondary" title="Draw circle to search area" aria-label="Draw circle">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="9"/>
            </svg>
          </button>
        </div>

        <div class="control-group">
          <button id="refresh-btn" class="btn btn-secondary">
            &#8635; Refresh
          </button>
          <button id="playback-btn" class="btn btn-secondary">
            &#9654; Playback
          </button>
          <button id="item-search-btn" class="btn btn-secondary">
            &#128269; Search by Item
          </button>
          <span id="loading-indicator" class="loading-indicator">
            <span class="loading-spinner"></span>
            Loading...
          </span>
        </div>

      </div>

      <!-- Map -->
      <div id="map"></div>

      <!-- Bottom Panel with Top-Level Tabs -->
      <div id="bottom-panel" class="bottom-panel" style="display: none;">
        <div class="bottom-panel-header">
          <div class="bottom-panel-left-actions">
            <button id="close-bottom-panel" class="btn btn-icon btn-close-panel" title="Close">X</button>
            <button id="expand-bottom-panel" class="btn btn-icon" title="Expand panel">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 3 21 3 21 9"></polyline>
                <polyline points="9 21 3 21 3 15"></polyline>
                <line x1="21" y1="3" x2="14" y2="10"></line>
                <line x1="3" y1="21" x2="10" y2="14"></line>
              </svg>
            </button>
          </div>
          <div class="bottom-panel-tabs">
            <button class="top-tab-btn active" data-top-tab="player-info">Player Info</button>
            <button class="top-tab-btn" data-top-tab="item-search">Item Search</button>
            <button class="top-tab-btn" data-top-tab="area-search">Area Search</button>
          </div>
        </div>

        <!-- Top-Level Tab Content -->
        <div class="top-tab-content">
          <!-- Player Info Tab -->
          <div id="top-tab-player-info" class="top-tab-pane active">
            <div class="player-info-content">
              <div class="player-info-header-row">
                <h3 id="player-info-name">Select a player</h3>
              </div>
              <div class="player-info-stats" id="player-info-stats">
                <!-- Basic stats: position, status, playtime, currency, last seen -->
              </div>
              <div class="player-info-tabs-container">
                <div class="player-info-tabs">
                  <button class="tab-btn active" data-tab="inventory">Inventory</button>
                  <button class="tab-btn" data-tab="movement">Movement</button>
                </div>
                <div class="tab-content">
                  <div id="tab-inventory" class="tab-pane active">
                    <div class="player-info-inventory">
                      <div class="inventory-current">
                        <h4>Current Inventory</h4>
                        <div id="current-inventory-table"></div>
                      </div>
                      <div class="inventory-timeline">
                        <h4>Inventory Changes</h4>
                        <div class="timeline-note">Using time range from controls above</div>
                        <div id="inventory-diff-list"></div>
                      </div>
                    </div>
                  </div>
                  <div id="tab-movement" class="tab-pane">
                    <div class="movement-stats" id="movement-stats">
                      <!-- Distance, speed stats -->
                    </div>
                    <div class="movement-timeline" id="movement-timeline">
                      <!-- Position timeline -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Item Search Tab -->
          <div id="top-tab-item-search" class="top-tab-pane">
            <div class="item-search-tab-content">
              <div class="item-search-input-section">
                <div class="item-search-wrapper">
                  <input type="text" id="item-search" class="item-search" placeholder="Search for an item..." list="item-suggestions" autocomplete="off" />
                  <datalist id="item-suggestions"></datalist>
                </div>
                <div id="item-filter-indicator" class="item-filter-indicator" style="display: none;">
                  <span id="item-filter-text">Searching for: </span>
                  <button id="clear-item-filter-btn" class="btn btn-sm">Clear</button>
                </div>
              </div>
              <div class="item-search-results">
                <div class="item-search-header">
                  <h4>Players with this item</h4>
                  <div id="item-search-query" class="item-search-query"></div>
                </div>
                <div id="item-search-results-list" class="item-search-results-list">
                  <div class="item-search-empty">Search for an item above or click an item in a player's inventory to find all players who have had it.</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Area Search Tab -->
          <div id="top-tab-area-search" class="top-tab-pane">
            <div class="area-search-tab-content">
              <div class="area-search-header">
                <span id="area-search-count">Draw a rectangle or circle on the map to search</span>
                <button id="clear-area-search" class="btn btn-sm" style="display: none;">Clear</button>
              </div>
              <div id="area-search-results-list" class="area-search-results">
                <div class="area-search-empty">Use the rectangle or circle tools above the map to select an area and find players who were there.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Area Search Results Panel - removed, now uses player list filter -->

      <!-- Player List Panel -->
      <div id="player-list-panel" class="player-list-panel">
        <button id="player-list-toggle" class="player-list-toggle" title="Toggle player list">
          <span class="toggle-icon">&lt;</span>
        </button>
        <div class="player-list-content">
          <div class="player-list-header">
            <h3>Players</h3>
            <input type="text" id="player-search" class="player-search" placeholder="Search players..." />
            <div class="player-selection-controls">
              <button id="select-all-btn" class="btn btn-sm">Select All</button>
              <button id="deselect-all-btn" class="btn btn-sm">Deselect All</button>
            </div>
            <div class="player-list-stats">
              <span id="panel-selected-count">0 selected</span>
            </div>
          </div>
          <div class="player-list-body">
            <div class="player-group" id="online-players-group">
              <div class="player-group-header" data-group="online">
                <span class="group-collapse-icon">&#9660;</span>
                <input type="checkbox" id="select-all-online" class="group-select-checkbox" checked />
                <span class="group-indicator online"></span> Online
                <span class="group-count" id="online-count">(0)</span>
              </div>
              <ul id="online-players-list" class="player-list"></ul>
            </div>
            <div class="player-group" id="offline-players-group">
              <div class="player-group-header" data-group="offline">
                <span class="group-collapse-icon">&#9660;</span>
                <input type="checkbox" id="select-all-offline" class="group-select-checkbox" />
                <span class="group-indicator offline"></span> Offline
                <span class="group-count" id="offline-count">(0)</span>
              </div>
              <ul id="offline-players-list" class="player-list"></ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Playback Controls (hidden by default) -->
      <div id="playback-controls" class="playback-panel" style="display: none;">
        <button id="play-pause-btn" class="btn">&#9654;</button>
        <input type="range" id="playback-slider" min="0" max="100" value="0" />
        <span id="playback-time">--:--:--</span>
        <select id="playback-speed">
          <option value="1">1x</option>
          <option value="2">2x</option>
          <option value="5" selected>5x</option>
          <option value="10">10x</option>
        </select>
        <button id="close-playback-btn" class="btn btn-icon">&times;</button>
      </div>

      <!-- Status Bar -->
      <div class="status-bar">
        <span id="player-count">Players: 0 online, 0 offline</span>
        <span id="cursor-coords">X: --, Z: --</span>
        <span id="last-update">Last update: --</span>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <!-- Bundled TypeScript frontend -->
  <script src="dist/bundle.js"></script>
</body>
</html>
